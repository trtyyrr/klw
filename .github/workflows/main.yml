name: ğŸš€ è‡ªåŠ¨ç¼–è¯‘å¹¶å‘å¸ƒæ­£å¼ç‰ˆ

on:
  push:
    tags:
      - 'v*' # æ¨é€ v å¼€å¤´çš„æ ‡ç­¾è§¦å‘

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 2. å®‰è£… NDK ç¯å¢ƒ
        run: |
          echo "y" | sudo ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --install "ndk;26.1.10909125"
          echo "ANDROID_NDK_HOME=${ANDROID_HOME}/ndk/26.1.10909125" >> $GITHUB_ENV

      - name: 3. æ‰§è¡Œç¼–è¯‘ (åˆ›é€ æ ¸å¿ƒæ–‡ä»¶)
        run: |
          SUB_DIR="MyKSUModule"
          CLANG="${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android33-clang++"
          STRIP="${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip"
          
          # ç¼–è¯‘ main.cpp åˆ°äºŒè¿›åˆ¶ thread_manager
          $CLANG "$SUB_DIR/src/main.cpp" -o "$SUB_DIR/thread_manager" -O3 -static-libstdc++
          $STRIP "$SUB_DIR/thread_manager"

      - name: 4. ç›®å½•é¢„å¤„ç† (åˆ é™¤æºç )
        run: |
          SUB_DIR="MyKSUModule"
          # ä¿®å¤æ¢è¡Œç¬¦æƒé™
          find "$SUB_DIR" -name "*.sh" -exec sed -i 's/\r$//' {} +
          chmod +x "$SUB_DIR"/*.sh "$SUB_DIR/thread_manager"
          
          # åˆ›å»ºæ ‡å‡†å®‰è£…ç›®å½• (å¦‚æœä¸å­˜åœ¨)
          mkdir -p "$SUB_DIR/META-INF/com/google/android/"
          [ ! -f "$SUB_DIR/META-INF/com/google/android/update-binary" ] && echo "#!/sbin/sh" > "$SUB_DIR/META-INF/com/google/android/update-binary"
          
          # --- å…³é”®ä¸€æ­¥ï¼šæ‰“åŒ…å‰åˆ é™¤ src æºç ç›®å½•ï¼Œç¡®ä¿ä¸æ³„éœ²æºç  ---
          rm -rf "$SUB_DIR/src"

      - name: 5. æ‰“åŒ…æ¨¡å— Zip
        id: pack
        run: |
          SUB_DIR="MyKSUModule"
          ZIP_NAME="UltraPowerSaver_${{ github.ref_name }}.zip"
          
          cd "$SUB_DIR"
          # æ‰“åŒ…å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ (æ­¤æ—¶ src å·²è¢«åˆ æ‰)
          zip -r "../$ZIP_NAME" ./* -x ".git*"
          echo "zip_path=$ZIP_NAME" >> $GITHUB_OUTPUT

      - name: 6. ç›´æ¥ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.pack.outputs.zip_path }}
          tag_name: ${{ github.ref_name }}
          name: "æ­£å¼å‘å¸ƒ ${{ github.ref_name }}"
          body: |
            ### æ„å»ºæ—¥å¿—
            - çŠ¶æ€: ç¼–è¯‘æˆåŠŸå¹¶å·²å‰”é™¤æºç 
            - æ ¸å¿ƒ: C++ çº¿ç¨‹ç®¡ç†å™¨ (arm64-v8a)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}