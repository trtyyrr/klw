name: ğŸš€ è‡ªåŠ¨ç¼–è¯‘å¹¶å‘å¸ƒæ­£å¼ç‰ˆ

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 2. å®‰è£… NDK ç¯å¢ƒ
        run: |
          echo "y" | sudo ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --install "ndk;26.1.10909125"
          echo "ANDROID_NDK_HOME=${ANDROID_HOME}/ndk/26.1.10909125" >> $GITHUB_ENV

      - name: 3. æ‰§è¡Œç¼–è¯‘
        run: |
          SUB_DIR="MyKSUModule"
          CLANG="${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android33-clang++"
          STRIP="${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip"
          
          # ç¼–è¯‘
          $CLANG "$SUB_DIR/src/main.cpp" -o "$SUB_DIR/thread_manager" -O3 -static-libstdc++
          $STRIP "$SUB_DIR/thread_manager"

      - name: 4. ç›®å½•é¢„å¤„ç† (ä»…åˆ é™¤ cpp æºç )
        run: |
          SUB_DIR="MyKSUModule"
          
          # ä¿®å¤æ‰€æœ‰è„šæœ¬çš„æ¢è¡Œç¬¦
          find "$SUB_DIR" -name "*.sh" -exec sed -i 's/\r$//' {} +
          chmod -R +x "$SUB_DIR"/*.sh
          chmod +x "$SUB_DIR/thread_manager"
          
          # --- ç²¾å‡†åˆ é™¤ï¼šåªåˆ é™¤ src ç›®å½•ä¸‹çš„ .cpp æ–‡ä»¶ ---
          # è¿™æ · src ç›®å½•ä¼šè¢«ä¿ç•™ï¼Œé‡Œé¢çš„ .sh è„šæœ¬ä¹Ÿä¼šè¢«ä¿ç•™
          rm -f "$SUB_DIR/src"/*.cpp
          
          # å¦‚æœä½ è¿˜æœ‰ .h å¤´æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä¸€å¹¶åˆ æ‰
          rm -f "$SUB_DIR/src"/*.h

      - name: 5. æ‰“åŒ…æ¨¡å— Zip
        id: pack
        run: |
          SUB_DIR="MyKSUModule"
          ZIP_NAME="UltraPowerSaver_${{ github.ref_name }}.zip"
          
          cd "$SUB_DIR"
          # æ‰“åŒ…æ‰€æœ‰æ–‡ä»¶ (æ­¤æ—¶ src è¿˜åœ¨ï¼Œä½†é‡Œé¢åªå‰©è„šæœ¬äº†)
          zip -r "../$ZIP_NAME" ./* -x ".git*" -x "Makefile"
          echo "zip_path=$ZIP_NAME" >> $GITHUB_OUTPUT

      - name: 6. ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.pack.outputs.zip_path }}
          tag_name: ${{ github.ref_name }}
          name: "æ­£å¼å‘å¸ƒ ${{ github.ref_name }}"
          body: |
            ### æ„å»ºæˆåŠŸ
            - **æ ¸å¿ƒ**: ç¼–è¯‘å®Œæˆ
            - **æ¸…ç†**: å·²ç§»é™¤ .cpp æºä»£ç ï¼Œä¿ç•™äº† src è¾…åŠ©è„šæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}