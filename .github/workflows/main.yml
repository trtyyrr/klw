name: 自动构建 KSU 模块 (方案B)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 NDK
        run: |
          echo "y" | sudo ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --install "ndk;26.1.10909125"
          echo "ANDROID_NDK_HOME=${ANDROID_HOME}/ndk/26.1.10909125" >> $GITHUB_ENV

      - name: 编译 C++ 线程管理器
        run: |
          # 定义嵌套文件夹名称
          SUB_DIR="MyKSUModule"
          
          # 获取编译器路径
          CLANG_PATH="${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android33-clang++"
          STRIP_PATH="${{ env.ANDROID_NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip"
          
          # 执行编译 (指定到子文件夹内的路径)
          $CLANG_PATH "$SUB_DIR/src/main.cpp" -o "$SUB_DIR/thread_manager" -O3 -static-libstdc++
          $STRIP_PATH "$SUB_DIR/thread_manager"

      - name: 准备并打包模块
        run: |
          SUB_DIR="MyKSUModule"
          # 进入子文件夹进行打包操作
          cd "$SUB_DIR"
          
          # 修复换行符权限
          find . -name "*.sh" -exec sed -i 's/\r$//' {} +
          sed -i 's/\r$//' module.prop
          chmod +x *.sh src/*.sh thread_manager
          
          # 获取版本号并打包到上层目录
          VERSION=$(grep "version=" module.prop | cut -d= -f2)
          zip -r "../UltraPowerSaver_${VERSION}.zip" ./* \
          -x "src/*.cpp" -x "Makefile" -x "*.md"

      - name: 上传构建结果
        uses: actions/upload-artifact@v4
        with:
          name: KSU-Module-Release
          path: "*.zip"